<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.software.content.mapper.ContentMapper">

    <!-- 批量插入标签关联 -->
    <insert id="batchInsertTags">
        INSERT INTO content_tag (content_id, tag_id, created_at, updated_at)
        VALUES
        <foreach collection="tags" item="tagId" separator=",">
            (#{contentId}, #{tagId}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- 批量插入媒体文件 -->
    <insert id="batchInsertMedias">
        INSERT INTO content_media (media_id, content_id, file_url, type, created_at, updated_at)
        VALUES
        <foreach collection="medias" item="media" separator=",">
            (#{media.mediaId}, #{contentId}, #{media.fileUrl}, #{media.type}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- 删除指定内容的所有标签关联 -->
    <delete id="deleteTagsByContentId">
        UPDATE content_tag 
        SET deleted_at = NOW()
        WHERE content_id = #{contentId} AND deleted_at IS NULL
    </delete>

    <!-- 删除指定内容的所有媒体文件 -->
    <delete id="deleteMediasByContentId">
        UPDATE content_media 
        SET deleted_at = NOW()
        WHERE content_id = #{contentId} AND deleted_at IS NULL
    </delete>
    <select id="selectContentDetailPage" resultMap="ContentDetail">
        SELECT
            c.content_id,
            c.user_id,
            c.content_type,
            c.title,
            c.description,
            c.is_public,
            c.status,
            c.created_at,
            c.updated_at,
            c.deleted_at,
            t.tag_id,
            t.tag_name,
            t.is_active,
            t.created_at AS tag_created_at,
            t.updated_at AS tag_updated_at,
            t.deleted_at AS tag_deleted_at,
            m.media_id,
            m.content_id AS media_content_id,
            m.file_url,
            m.type AS media_type,
            m.created_at AS media_created_at,
            m.updated_at AS media_updated_at,
            m.deleted_at AS media_deleted_at
        FROM content c
        LEFT JOIN content_tag ct ON c.content_id = ct.content_id AND ct.deleted_at IS NULL
        LEFT JOIN tag t ON ct.tag_id = t.tag_id AND t.deleted_at IS NULL
        LEFT JOIN content_media m ON c.content_id = m.content_id AND m.deleted_at IS NULL
        WHERE c.deleted_at IS NULL
        ORDER BY c.created_at DESC
    </select>

    <!-- ResultMap定义 -->
    <resultMap id="BaseResultMap" type="org.software.model.content.Content">
        <id column="content_id" property="contentId" />
        <result column="user_id" property="userId" />
        <result column="content_type" property="contentType" />
        <result column="title" property="title" />
        <result column="description" property="description" />
        <result column="is_public" property="isPublic" />
        <result column="status" property="status" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
        <result column="deleted_at" property="deletedAt" />
    </resultMap>

    <resultMap id="ContentDetail" type="org.software.model.content.vo.ContentDetailVO">
        <id column="content_id" property="contentId" />
        <result column="user_id" property="userId" />
        <result column="content_type" property="contentType" />
        <result column="title" property="title" />
        <result column="description" property="description" />
        <result column="is_public" property="isPublic" />
        <result column="status" property="status" />
        <result column="cover_url" property="coverUrl" />
        <result column="like_count" property="likeCount" />
        <result column="favorite_count" property="favoriteCount" />
        <result column="comment_count" property="commentCount" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
        <result column="deleted_at" property="deletedAt" />
<!--        <association property="user" javaType="org.software.model.user.UserV">-->
<!--            <result column="userv_id" property="userId" />-->
<!--            <result column="userv_username" property="username" />-->
<!--            <result column="userv_avatar" property="avatar" />-->
<!--            <result column="userv_nickname" property="nickname" />-->
<!--        </association>-->
        <collection property="tags" ofType="org.software.model.content.Tag">
            <id column="tag_id" property="tagId" />
            <result column="tag_name" property="tagName" />
            <result column="is_active" property="isActive" />
            <result column="tag_created_at" property="createdAt" />
            <result column="tag_updated_at" property="updatedAt" />
            <result column="tag_deleted_at" property="deletedAt" />
        </collection>
        <collection property="medias" ofType="org.software.model.media.ContentMedia">
            <id column="media_id" property="mediaId" />
            <result column="media_content_id" property="contentId" />
            <result column="file_url" property="fileUrl" />
            <result column="media_type" property="type" />
            <result column="media_created_at" property="createdAt" />
            <result column="media_updated_at" property="updatedAt" />
            <result column="media_deleted_at" property="deletedAt" />
        </collection>
    </resultMap>

</mapper>
